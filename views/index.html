
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valhalla Fitness Tracker</title>
     <link rel="stylesheet" href="/public/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">‚öîÔ∏è Valhalla Fitness Tracker ‚öîÔ∏è</h1>
            <p class="subtitle">Train like a Viking warrior, track your legendary deeds</p>
        </header>

        <div class="grid">
            <!-- Create User Section -->
            <div class="section">
                <h2 class="section-title">üõ°Ô∏è Create New Viking</h2>
                <form id="create-user-form">
                    <div class="form-group">
                        <label for="username">Viking Name:</label>
                        <input type="text" id="username" name="username" required placeholder="Enter your warrior name...">
                    </div>
                    <button type="submit" class="btn">Create Warrior</button>
                </form>
                <div id="user-result"></div>
            </div>

            <!-- Add Exercise Section -->
            <div class="section">
                <h2 class="section-title">‚öíÔ∏è Log Training Session</h2>
                <form id="add-exercise-form">
                    <div class="form-group">
                        <label for="userId">Viking ID:</label>
                        <input type="text" id="userId" name="userId" required placeholder="Enter your Viking ID...">
                    </div>
                    <div class="form-group">
                        <label for="description">Training Description:</label>
                        <input type="text" id="description" name="description" required placeholder="Sword training, shield practice, etc...">
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (minutes):</label>
                        <input type="number" id="duration" name="duration" required min="1" placeholder="Training duration...">
                    </div>
                    <div class="form-group">
                        <label for="date">Date (optional):</label>
                        <input type="date" id="date" name="date">
                    </div>
                    <button type="submit" class="btn">Log Training</button>
                </form>
                <div id="exercise-result"></div>
            </div>
        </div>

        <!-- Get Exercise Log Section -->
        <div class="section">
            <h2 class="section-title">üìú Viking Training Chronicle</h2>
            <form id="get-log-form">
                <div class="grid">
                    <div class="form-group">
                        <label for="logUserId">Viking ID:</label>
                        <input type="text" id="logUserId" name="userId" required placeholder="Enter Viking ID...">
                    </div>
                    <div class="form-group">
                        <label for="from">From Date (optional):</label>
                        <input type="date" id="from" name="from">
                    </div>
                    <div class="form-group">
                        <label for="to">To Date (optional):</label>
                        <input type="date" id="to" name="to">
                    </div>
                    <div class="form-group">
                        <label for="limit">Limit (optional):</label>
                        <input type="number" id="limit" name="limit" min="1" placeholder="Number of entries...">
                    </div>
                </div>
                <button type="submit" class="btn">Retrieve Chronicle</button>
            </form>
            <div id="log-result"></div>
        </div>
    </div>

    <script>
        // In-memory database simulation
        const database = {
            users: new Map(),
            exercises: new Map(),
            userIdCounter: 1,
            exerciseIdCounter: 1
        };

        // Helper function to generate ObjectId-like string
        function generateId() {
            return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        // Helper function to format date
        function formatDate(date) {
            return new Date(date).toDateString();
        }

        // Helper function to show loading state
        function showLoading(button) {
            const originalText = button.textContent;
            button.innerHTML = originalText + '<span class="loading"></span>';
            button.disabled = true;
            return originalText;
        }

        function hideLoading(button, originalText) {
            button.textContent = originalText;
            button.disabled = false;
        }

        // Helper function to display results
        function displayResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            const resultClass = isError ? 'error' : 'success';
            
            if (typeof data === 'object') {
                element.innerHTML = `
                    <div class="result-section">
                        <div class="result-title">${isError ? '‚ùå Error' : '‚úÖ Success'}</div>
                        <div class="result-content">${JSON.stringify(data, null, 2)}</div>
                    </div>
                `;
            } else {
                element.innerHTML = `<div class="${resultClass}">${data}</div>`;
            }
        }

        // Create User API
        async function createUser(userData) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    try {
                        const { username } = userData;
                        
                        if (!username || username.trim() === '') {
                            reject(new Error('Username is required'));
                            return;
                        }

                        // Check if username already exists
                        for (let user of database.users.values()) {
                            if (user.username === username.trim()) {
                                reject(new Error('Username already exists'));
                                return;
                            }
                        }

                        const userId = generateId();
                        const user = {
                            username: username.trim(),
                            _id: userId
                        };

                        database.users.set(userId, user);
                        resolve(user);
                    } catch (error) {
                        reject(error);
                    }
                }, 500);
            });
        }

        // Add Exercise API
        async function addExercise(exerciseData) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    try {
                        const { userId, description, duration, date } = exerciseData;

                        if (!userId || !description || !duration) {
                            reject(new Error('User ID, description, and duration are required'));
                            return;
                        }

                        const user = database.users.get(userId);
                        if (!user) {
                            reject(new Error('User not found'));
                            return;
                        }

                        const exerciseId = generateId();
                        const exerciseDate = date ? new Date(date) : new Date();
                        
                        const exercise = {
                            username: user.username,
                            description: description.trim(),
                            duration: parseInt(duration),
                            date: formatDate(exerciseDate),
                            _id: exerciseId
                        };

                        // Store exercise with user reference
                        if (!database.exercises.has(userId)) {
                            database.exercises.set(userId, []);
                        }
                        database.exercises.get(userId).push(exercise);

                        resolve(exercise);
                    } catch (error) {
                        reject(error);
                    }
                }, 500);
            });
        }

        // Get Exercise Log API
        async function getExerciseLog(params) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    try {
                        const { userId, from, to, limit } = params;

                        if (!userId) {
                            reject(new Error('User ID is required'));
                            return;
                        }

                        const user = database.users.get(userId);
                        if (!user) {
                            reject(new Error('User not found'));
                            return;
                        }

                        let exercises = database.exercises.get(userId) || [];

                        // Filter by date range if provided
                        if (from || to) {
                            exercises = exercises.filter(exercise => {
                                const exerciseDate = new Date(exercise.date);
                                const fromDate = from ? new Date(from) : new Date('1900-01-01');
                                const toDate = to ? new Date(to) : new Date('2100-12-31');
                                
                                return exerciseDate >= fromDate && exerciseDate <= toDate;
                            });
                        }

                        // Apply limit if provided
                        if (limit && limit > 0) {
                            exercises = exercises.slice(0, parseInt(limit));
                        }

                        // Format response according to specification
                        const log = exercises.map(exercise => ({
                            description: exercise.description,
                            duration: exercise.duration,
                            date: exercise.date
                        }));

                        const response = {
                            username: user.username,
                            count: exercises.length,
                            _id: userId,
                            log: log
                        };

                        resolve(response);
                    } catch (error) {
                        reject(error);
                    }
                }, 500);
            });
        }

        // Event Listeners
        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            const originalText = showLoading(button);
            
            try {
                const formData = new FormData(e.target);
                const userData = Object.fromEntries(formData);
                const result = await createUser(userData);
                displayResult('user-result', result);
                e.target.reset();
            } catch (error) {
                displayResult('user-result', { error: error.message }, true);
            } finally {
                hideLoading(button, originalText);
            }
        });

        document.getElementById('add-exercise-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            const originalText = showLoading(button);
            
            try {
                const formData = new FormData(e.target);
                const exerciseData = Object.fromEntries(formData);
                const result = await addExercise(exerciseData);
                displayResult('exercise-result', result);
                e.target.reset();
            } catch (error) {
                displayResult('exercise-result', { error: error.message }, true);
            } finally {
                hideLoading(button, originalText);
            }
        });

        document.getElementById('get-log-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            const originalText = showLoading(button);
            
            try {
                const formData = new FormData(e.target);
                const params = Object.fromEntries(formData);
                const result = await getExerciseLog(params);
                
                // Display the log in a more user-friendly format
                const logElement = document.getElementById('log-result');
                logElement.innerHTML = `
                    <div class="result-section">
                        <div class="result-title">üìú ${result.username}'s Training Chronicle</div>
                        <div style="margin-bottom: 15px;">
                            <strong>Total Sessions:</strong> ${result.count}
                        </div>
                        <div class="exercise-log">
                            ${result.log.map(exercise => `
                                <div class="exercise-item">
                                    <div class="exercise-meta">
                                        <span class="exercise-duration">${exercise.duration} min</span>
                                        <span class="exercise-date">${exercise.date}</span>
                                    </div>
                                    <div><strong>${exercise.description}</strong></div>
                                </div>
                            `).join('')}
                            ${result.log.length === 0 ? '<div class="exercise-item">No training sessions found for this Viking.</div>' : ''}
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Raw JSON Response:</strong>
                            <div class="result-content">${JSON.stringify(result, null, 2)}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                displayResult('log-result', { error: error.message }, true);
            } finally {
                hideLoading(button, originalText);
            }
        });

        // Initialize with some demo data
        setTimeout(async () => {
            try {
                // Create a demo user
                const demoUser = await createUser({ username: 'Ragnar_Ironbeard' });
                
                // Add some demo exercises
                await addExercise({
                    userId: demoUser._id,
                    description: 'Sword Training',
                    duration: 45,
                    date: '2025-01-15'
                });
                
                await addExercise({
                    userId: demoUser._id,
                    description: 'Shield Wall Practice',
                    duration: 60,
                    date: '2025-01-16'
                });
                
                await addExercise({
                    userId: demoUser._id,
                    description: 'Battle Axe Mastery',
                    duration: 30,
                    date: '2025-01-17'
                });
                
                console.log('Demo data initialized!');
                console.log('Demo Viking ID:', demoUser._id);
            } catch (error) {
                console.error('Error initializing demo data:', error);
            }
        }, 1000);
    </script>
</body>
</html>